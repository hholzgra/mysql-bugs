# MySQL Bugs: #69638
# Wrong results when running a SELECT that includes a HAVING based on a function
# http://bugs.mysql.com/bug.php?id=69638

--disable_warnings
DROP TABLE IF EXISTS t1;
--enable_warnings

CREATE TABLE `t1` (
  id int primary key auto_increment,
  val int,
  KEY `idx` (`val`)
) ENGINE=InnoDB;

INSERT INTO t1 SELECT NULL, FLOOR(RAND(1)*1000);
INSERT INTO t1 SELECT NULL, FLOOR(RAND(1)*1000) FROM t1;
INSERT INTO t1 SELECT NULL, FLOOR(RAND(1)*1000) FROM t1;
INSERT INTO t1 SELECT NULL, FLOOR(RAND(1)*1000) FROM t1;
INSERT INTO t1 SELECT NULL, FLOOR(RAND(1)*1000) FROM t1;
INSERT INTO t1 SELECT NULL, FLOOR(RAND(1)*1000) FROM t1;
INSERT INTO t1 SELECT NULL, FLOOR(RAND(1)*1000) FROM t1;
INSERT INTO t1 SELECT NULL, FLOOR(RAND(1)*1000) FROM t1;
INSERT INTO t1 SELECT NULL, FLOOR(RAND(1)*1000) FROM t1;
INSERT INTO t1 SELECT NULL, FLOOR(RAND(1)*1000) FROM t1;
INSERT INTO t1 SELECT NULL, FLOOR(RAND(1)*1000) FROM t1;

SELECT val, (rand(3)*100) AS r FROM t1 group by val HAVING r < 20 ORDER BY r DESC LIMIT 15;


SELECT val, (rand(3)*100) AS r FROM t1 IGNORE INDEX (idx) group by val HAVING r < 20 ORDER BY r DESC LIMIT 15;

